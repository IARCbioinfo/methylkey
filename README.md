# Methylkey

## Running QC on illumina array with Minfi

### minfiQC.r

Load data and run QC
```bash
  Rscript methylkey/R/dataLoader.minfi.r --pdata pdata.csv --idat idat --group Smoking_status,Sentrix_ID --model ~Smoking_status --out waterpipe
```

Run the same from gitlab

```bash
  Rscript <(curl http://git.iarc.lan/EGE/methylkey/raw/master/R/dataLoader.minfi.r) --pdata pdata.csv --idat idat --group Smoking_status,Sentrix_ID --model ~Smoking_status --out waterpipe
```

### Inputs

You can start from your idat files and a sample sheet, in that case use --pdata and --idat parameters for your inputs.<br/>
Or you can resume an analysis using an rda object generated by a previous run. Use --meth parameter.<br/>
(This file contain the RGset object + all parameters + some results)

  | Mandatory parameters   | Example value       |     Description                                                          |
  |:-----------------------|:--------------------|:-------------------------------------------------------------------------|
  | --pdata                | pdata.tsv           | Sample sheet in tsv format (tabular sepated texte file)                  |
  | --idat                 | ./idat              | Folder containing all idat files                                         |
  |   or                   |                     |                                                                          |
  | --meth                 | myproject/RGset.rda | RGset.rda file                                                           |
 

* pdata is a tabular file with samples as lines and variables as columns. This file must include : 
  * samples names (which have to be unique)
  * Barcode (203021070069_R03C01) : this code is the link between samples and idat files. The fist number (203021070069) is the sentrix id, while (R03C01) is the sentrix position. The associated idat files are *203021070069_R03C01_red.idat* for the red channel and *203021070069_R03C01_green.idat* for the green channel.

* idat is a folder that contains all idats files associated with your samples.

* RGset.rda file is generated by this script to save the minfi RGset object. It contains 3 objects : 
  * opt_  : Parameters of your analysis.
  * RGset : minfi object required by several tools that contains all idats informations.
  * Analysis : Formatted pdata + some interm√©diate results

### Parameters

  | Optional parameters    | Example value   |     Description                                                          |
  |:-----------------------|:----------------|:-------------------------------------------------------------------------|
  | --normalize            | SWANoob         | Normalization method : default(Funnorm)  <br/> Funnorm, Illumina, Noob, Quantile, SWANoob or SWAN |
  | --samples              | Sample_ID       | Samples' column names in the sample sheet                                |
  | --barcode              | Sentrix_ID      | Barcodes' column names in the sample sheet                               |
  | --groups               | Smoking,Age     | List of groups (columns' names in Sample sheet), Default is Sentrix_ID.<br/> The first group is used to calculate mean betas<br/>  when replacing NA values by mean by group. |
  | --missing              | mean            | Missing values : <br/>1- mean   : replace by mean by group (default) <br/>2- impute : impute missing values with pamr <br/>3- keep   : keep na values |
  | --nalimit              | 0.2             | Remove probes with proportion of missing value above this threshold.     |
  | --pval                 | 0.02            | Remove probes with signal Pvalue above this threshold.                   |
  | --model                | ~Smoking        | Model used for SVA batch correction                                      |
  | --separator            | "\t"            | Field separator for Sample Sheet (default "\t")                          |
  | --out                  | myproject/      | Output folder name (default minfi_result)                                |
  | --badsamples           | mylist.txt      | Texte file, each line is the id of a sample to remove from the analysis  |
  | --filter               | Sex_EPIC.csv    | file(s) listing probes to remove from the analysis <br/>  default for EPIC : Crossreactive_probes_EPIC.csv,SNP_EPIC,SNP_ALL_races_5percent.csv,Sex_EPIC.csv |
  
* model : In the model you put the variables you want to protect from batch correction. You should at least protect your main variable, but you can also add covariates with '+'. eg ~Smoking+Gender+Age
* badsamples : If one or more samples are out of the limits in Quality Control report, you can rerun the analysis by removing them using this option. Alternativelly you can remove them from the samplesheet.
* filter : 
  * Pidsley, R., Zotenko, E., Peters, T.J. et al. Critical evaluation of the Illumina MethylationEPIC BeadChip microarray for whole-genome DNA methylation profiling. Genome Biol 17, 208 (2016). https://doi.org/10.1186/s13059-016-1066-1
  * Yi-an Chen, Mathieu Lemire, Sanaa Choufani, Darci T. Butcher, Daria Grafodatskaya, Brent W. Zanke, Steven Gallinger, Thomas J. Hudson & Rosanna Weksberg (2013) Discovery of cross-reactive probes and polymorphic CpGs in the Illumina Infinium HumanMethylation450 microarray, Epigenetics, 8:2, 203-209, https://doi.org/10.4161/epi.23470


  | Flags parameters       |     Description              |
  |:-----------------------|:-----------------------------|
  | --nosva                | Do not run batch correction  |



