---
title: "methylkey example"
author: Cahais Vincent
output:
  rmdformats::readthedown:
    toc_depth: 3
    theme: lumen
params:
  #idat: "/data/EPI_EBV_Myco/work/cahaisv/idat_all/"
  idat: "/luca/idat_all/"
  sampleSheet : "/data/EPI_EBV_Myco/work/cahaisv/methylkey_20230801/sampleSheet_OTA_303.csv"
  prepcode : "QCDPB"
  output : "EBV"
  groups : !r c("EBV","OTA","Sentrix_ID","inferedsex")
  model_sva : "~ebv"
  palette : "npg"
  size : 1
  showlabels : FALSE
  ellipse : TRUE
  sva: TRUE
---

```{R setup, echo=FALSE, warning=FALSE, message=FALSE}
knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning=FALSE)
#devtools::load_all("/luca/git/methylkey/")
library(tidyverse)
library(dplyr)
library(readr)
library(SummarizedExperiment)
#source("/luca/git/methylkey/R/MethylKeySet.r")
source("/luca/git/methylkey/R/MethylKey.r")
source("/luca/git/methylkey/R/pipelines.r")
source("/luca/git/methylkey/R/missingValues.r")
source("/luca/git/methylkey/R/plots.r")
source("/luca/git/methylkey/R/utils.r")
source("/luca/git/methylkey/R/batchcorrection.r")
source("/luca/git/methylkey/R/pca.r")
source("/luca/git/methylkey/R/dmrtools.r")
source("/luca/git/methylkey/R/annotation.r")
source("/luca/git/methylkey/R/regression.r")
source("/luca/git/methylkey/R/methylkey.diff.r")
source("/luca/git/methylkey/R/MethylResultSet.r")
library(assertthat)
library(sesame)
library(sesameData)
library(DescTools)
library(wheatmap)
library(ggpubr)
library(DT)
library(ggvenn)
```


```{R check_status}
rds_files <- list.files(pattern = "\\.rds$")
dates <- as.Date(sub(".*_(\\d{4}-\\d{2}-\\d{2})\\.rds", "\\1", rds_files), format = "%Y-%m-%d")
index_most_recent <- which.max(dates)
file0<-file.exists(paste0(params$output, "_raw_", dates[index_most_recent],".rds"))
file1<-file.exists(paste0(params$output, "_mval_", dates[index_most_recent],".rds"))
```

# 1- SampleSheet

```{R sampleSheet}
sampleSheet <- normalizePath(params$sampleSheet) %>% read_delim() %>% select(-c(Date,Sample_Well,Plate_ID)) %>%
  tidyr::separate(Basename,into=c("Sentrix_ID","Sentrix_Position"),remove = FALSE) %>% filter(Sentrix_ID==206402350107)
sampleSheet %>% datatable()
```

# 2- Quality Control {.tabset}

## 2.1- RedGrnQQ

```{R read_idats, eval=!file0}
# idats to sdfs
meth<-sesame2Betas(params$idat, prep = params$prepcode, sampleSheet=sampleSheet, na=0.2, ncore=4)
saveRDS(meth, file=paste0( params$output, "_raw_", Sys.Date(),".rds" ) )
```

```{R load_idats, eval=file0}
meth <- readRDS(paste0(params$output, "_raw_", dates[index_most_recent],".rds"))
```

```{R read_minfi, eval=!file0}
# idats to sdfs

meth<-minfi2Betas(idat="/data/EPI_EBV_Myco/files/ILL_20220919_EBV_myco/idats/", sampleSheet=sampleSheet, na=0.2, ncore=4)


```

## 2.2- Channels

```{R channels}
metadata(meth)$channels
```


## 2.3- Detection

```{R detection}
qcs<-metadata(meth)$qcs
plot_Detection(qcs[1:56,])
plot_Detection(qcs[57:112,])
plot_Detection(qcs[113:168,])
plot_Detection(qcs[169:224,])
```

## 2.4- NA

```{R NA}
plot_NA(qcs[1:56,])
plot_NA(qcs[57:112,])
plot_NA(qcs[113:168,])
plot_NA(qcs[169:224,])
```

## 2.5- Background

The background level is given by mean_oob_grn and mean_oob_red.

```{R background}
plot_background(qcs) 
```

# 3- Group Control

```{R mvals}
# get mvalues with only winsorized correction, but remove XY chromosomes
methM<-getMvals(meth, grp="EBV", sva=NULL, win=TRUE, sex=FALSE)
mvals<-getMvals(methM)
```

## 3.1- MDS

```{R mds, results = "asis"}
for(group in tolower(params$groups)){
  cat("\n\n### ", group, "\n\n")
  grp=colData(methM) %>% dplyr::pull(group)
  my_scatterPlot(mvals, grp, samples(methM), params$palette, params$size, params$showlabels, params$ellipse) %>% print()
}
```

## 3.2- PCA {.tabset}

```{R pca, results = "asis"}
pca <- makepca( mvals, colData(methM), nPC=9 )
plot_PCA_contribution(pca, nPC=9)

dfp <- estimate_PCA_corr(pca, colData(methM), nPC=9)
dfq <- apply(dfp, 2, p.adjust, method = "fdr") %>% matrix(nrow = nrow(dfp), dimnames = dimnames(dfp))

dfq %>% datatable()

for(group in tolower(params$groups) ){
  cat("\n\n### ", group, "\n\n")
  factoextra::fviz_pca_ind(pca, axes=c(1,2), habillage=colData(methM) %>% dplyr::pull(group), addEllipses=params$ellipse ) %>% print()
}
```


# 4- Data Correction

```{R correction, asis=TRUE, eval=!file1}
# This time we apply batch correction
sentrix2remove=c("2066444410180_R02C01")
#sentrix2remove=c("2066444410180_R02C01","206425820095_R01C01","206425820095_R02C01","206425820095_R02C01","206425820095_R02C01","206425820095_R02C01","206425820095_R02C01","206425820095_R02C01","206425820095_R02C01")
methM<-getMvals(meth, grp="EBV", sva="~ebv", win=TRUE, sex=FALSE, sentrix2remove=sentrix2remove)
saveRDS(methM,paste0(params$output, "_mval_", dates[index_most_recent],".rds"))
```

```{R load_correction, eval=file1}
methM <- readRDS(paste0(params$output, "_mval_", dates[index_most_recent],".rds"))
```

```{R getMvals}
mvals<-getMvals(methM)
```

## 4.1- MDS {.tabset}

```{R mds2, results = "asis"}
for(group in tolower(params$groups)){
  cat("\n\n### ", group, "\n\n")
  grp=colData(methM) %>% dplyr::pull(group)
  my_scatterPlot(mvals, grp, samples(methM), params$palette, params$size, params$showlabels, params$ellipse) %>% print()
}
```

## 4.2- PCA {.tabset}

```{R pca2, results = "asis"}
pca <- makepca( mvals, colData(methM), nPC=9 )
plot_PCA_contribution(pca, nPC=9)

dfp <- estimate_PCA_corr(pca, colData(methM), nPC=9)
dfq <- apply(dfp, 2, p.adjust, method = "fdr") %>% matrix(nrow = nrow(dfp), dimnames = dimnames(dfp))

dfq %>% datatable()

for(group in tolower(params$groups) ){
  cat("\n\n### ", group, "\n\n")
  factoextra::fviz_pca_ind(pca, axes=c(1,2), habillage=colData(methM) %>% dplyr::pull(group), addEllipses=params$ellipse ) %>% print()
}
```

# 5 Models {.tabset}

## 5.1 EBV

```{r model}
rm(meth)
gc()
mrs<-methyldiff2(model="~ebv",
           case ="YES",
           control="NO",
           se=methM,
           method="ls"
)
```

```{r annot}
annot<-readr::read_tsv("https://github.com/zhou-lab/InfiniumAnnotationV1/raw/main/Anno/EPIC/EPIC.hg38.manifest.gencode.v37.tsv.gz")
dmps<-left_join(as_tibble(mrs@dmps),annot, by="probeID") 
dmps %>% filter(adj.P.Val < 0.05) %>% datatable()
my_volcano( mrs@dmps )
dmrs<-left_join(getDMRs(mrs),annot, by="probeID")
dmrs %>% filter(fdr<0.05) %>% datatable()
my_venn(dmrs)
my_density(dmrs)
my_violin(dmrs)
my_volcanohmean(dmrs)
```


