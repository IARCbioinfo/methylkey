<?xml version="1.0"?>
<tool id="dmrs2" name="get DMRs" version="0.0.1">
<description>Deferentially methylated Regions</description>

<code file="getlevels.py"/>

<command>
	#import re
	#set inputDir=$re.sub("\.dat","_files",str($input))
	#set outputDir=$re.sub("\.dat","_files/",str($html))

	Rscript $__tool_directory__/../R/$dmr.package 
	--meth $inputDir/meth.rdata

	#if $dmr.package=="dmrcate.r"
		--type $dmr.analysis_type --fdr $dmr.fdr --pcutoff $dmr.pcutoff	
	#elif $dmr.package=="bumphunter.r"
		--cpu $dmr.nbcor --test $dmr.method --mval $dmr.mval --minNumOfCpgs $dmr.minNumOfCpgs
	#else
	    --min $dmr.minProbeNum --pcutoff $dmr.pValueTh --window $dmr.winsize --fdr $dmr.fdr
	#end if
	--output $html.files_path;

	mv $html.files_path/* $inputDir/. ;
	cp $inputDir/index.html $input;
	mkdir $outputDir;
	ln -sfvn $inputDir/* $outputDir/.;
	cp $input $html;
</command>

<inputs>

	<param name="input" type="data" format="html" label="report"/>
	
	<conditional name="dmr">
		<param name="package" type="select" label="Method">
			<option value="dmrcate.r">DMRcate</option>
			<option value="bumphunter.r">Bumphunter</option>
		</param>
		<when value="dmrcate.r">
			<param name="analysis_type" type="select" label="Type of Analysis">
				<option value="differential">differential (DMRs)</option>
				<option value="variability">variability (VMRs)</option>
			</param>
			<param name="fdr" type="text" value="0.05" label="FDR cutoff" help="FDR cutoff (Benjamini-Hochberg) for which CpG sites are individually called as  significant.   Used  only  to  determine  effect  size,  and  not  for  downstream thresholding."/>
			<param name="pcutoff" type="text" value="0.2" label="pcutoff" help="p-value cutoff to determine DMRs."/>
		</when>
		<when value="bumphunter.r">
			<param name="method" type="select" label="Test" help="The use of the permutation test is not recommended with multiple covariates, (ncol(design)>2).">
				<option value="permutation">permutation</option>
				<option value="bootstrap">bootstrap</option>
			</param>
			<param name="mval" type="boolean" checked="false" truevalue="-mval" falsevalue="" label="use mvalues" help="convert betas to mvalues, recommended for small datasets" />
			<param name="minNumOfCpgs" type="text" value="2" label="Minimum number of CpG for a DMRs" />
			<param name="nbcor" type="text" value="4" label="number of process" />	
		</when>
	</conditional>
	
	<param name="max" type="text" value="10" label="Max dmrs to plot" />

</inputs>

<outputs>
    <data name="html" format="html" label="${dmr.package}" />
</outputs>

<stdio>
    <regex match="Warning message:"
           source="both"
           level="warning"
           description="Warning message:" />
</stdio>

<help>


</help>

</tool>
