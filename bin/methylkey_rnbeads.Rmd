---
date: "`r format(Sys.time(), '%d %B, %Y')`"
title: "methylkey"
output: 
  flexdashboard::flex_dashboard:
    orientation: rows
params:
  path: "~/git/methylkey/bin/"
  pdata: "pdata.csv"
  idat: "data.csv.gz"
  pipeline: "rnbeads"
  samples: "sample_name"
  groups: "group"
  nalimit: 0.2
  missing: "mean"
  separator: "\t"
  out: "methylkey"
  violin: FALSE
  badsamples: "None"
  genome: "hg19"
---

```{r setup, echo=FALSE, include=FALSE}
#params=list(path="~/git/methylkey/bin/,  pdata="pdata.csv",  idat="data.csv.gz",  pipeline="rnbeads",  samples="sample_name",  groups="group", nalimit=0.2,  missing="mean",  separator=",",  out="methylkey",  violin=FALSE,  badsamples="None",  bed="None")
knitr::opts_chunk$set(echo = TRUE)
library(knitr)
library(formattable)
library(data.table)
library(wateRmelon)
source( paste0(params$path, "/utils.r")  )
source( paste0(params$path, "/plots.r")  )
source( paste0(params$path, "/annot.r")  )
source( paste0(params$path, "/pca.r")  )
source( paste0(params$path, "/missingValues.r")  )

#path <- dirname(strsplit(commandArgs()[4],"=")[[1]][2])
datadir<-paste0(params$path , "/../data/")
if ( !file.exists(params$out)) { dir.create(params$out) }
message(paste0("samples:", params$samples))
message(paste0("groups:", params$groups))
message(paste0("nalimit:", params$nalimit))
message(paste0("missing:", params$missing))
message(paste0("violin:", params$violin))
message(paste0("badsamples:", params$badsamples))
```

```{r autoformat, include=FALSE}
#samples<-suppressWarnings( autoformat(params$samples) )
#groups <-suppressWarnings( autoformat(params$groups) )
samples<-params$samples
groups <-params$groups
```

```{r loading, echo=FALSE, results ='asis'}
#1- load pdata
pdata<-read.table(params$pdata, sep=params$separator, header=T)
if( ncol(pdata)<2 ){ stop(paste0("Check if your separator in pdata is really '", params$separator, "'")) }
colnames(pdata)[ which(colnames(pdata)==samples) ] <-"sample_name"
if(file.exists(params$badsamples)){
  bad<-read.table(params$badsamples)$V1
  pdata<-pdata[ !pdata$sample_name %in% bad, ]
  message(paste0(length(bad), " samples listed in ", params$badsamples, " are removed !"))
}
```

```{r v2factor, include=FALSE}
#2- convert variables to factor
for (variable in colnames(pdata)){ 
  if (length(levels(factor(pdata[,variable]))) <= nrow(pdata)/8) 
  { 
  	pdata[,variable]<-as.factor(pdata[,variable]) 
  }  
}
```

```{r checkSamples, include=FALSE}
#3- check samples
tryCatch({
  samples<-pdata$sample_name
}, error = function(err) {
  stop(paste0("Check if '", samples, "' is a column in your pdata. You can specify the column's name for samples names with --samples "))
})
if(length(unique(samples))!=length(samples)){ 
  stop("Samples names must be uniques !")
}
for (sample in samples){
  message(sample)
}
```

```{r checkGroups, include=FALSE}
#5- check groups
for (group in groups) {
  tryCatch({
    if ( !is.factor(pdata[,group] )){
      groups<-groups[-which(groups==group)]
      print(paste0("warning : ", group, " removed from groups because it is numeric." )) 
    }else{
      dir.create(paste(params$out, colnames(pdata[group]), sep="/"))
    }
  }, error = function(err) {
    stop(paste0("Check if '", group, "' is a column in your pdata. You can specify the columns' names for groups with --groups "))
  })
}
groups<-colnames(pdata[groups])
```

```{r rnbeads, include=FALSE}
#6- read betas
filetype = summary( file(params$idat) )$class
if(filetype=="gzfile"){
	betas<-fread(cmd=paste0("zcat < '", params$idat, "'") , header=T, sep=",")
}else{
	betas<-fread(params$idat, header=T, sep=",")
}
regions<-betas[,1:5, with=F]
pdata<-pdata[ pdata$sample_name %in% colnames(betas),]
samples<-pdata$sample_name
betas<-betas[, colnames(betas) %in% pdata$sample_name, with=F]
message( paste0( length(pdata$sample_name), " samples in pdata, ", ncol(betas), " found in betas" ) )
betas<-as.matrix(betas)
nbprobes1=nrow(betas)
rownames(betas)<-regions$ID
platform<-"RRBS"
regions<-regions[,c(2,3,4,1)]
regions<-cbind(regions,rep(".",nrow(regions)),rep("*",nrow(regions)) )
regions<-makeGRangesFromDataFrame(regions, keep.extra.columns=TRUE)
colnames(regions@elementMetadata)[1]<-"name"
```

```{r navalues, include=FALSE}
#7- Select probes with percentage of NA values > nalimit
naprobes<-CpGNAexcl( betas,params$nalimit )
filteredNAprobes<-length(naprobes)
write.table(paste(naprobes, collapse="\n"), file=paste0(params$out, "/removed.txt"), row.names=F, sep="\t")
```

```{r missingvalues, include=FALSE}
#8- remove remaining missing values
if ( sum(is.na(betas)) > 0 ) {
	if (params$missing=="mean"){
		betas<-replaceByMean(betas,pdata[,groups[1]])
	}
	if (params$missing=="impute"){
		betas<-imputeNA(betas,nalimit)
	}
}
```

```{r QC, include=FALSE}
#9- QC after processing
for (group in groups) {
	  
	jpeg(paste(params$out, group, "densityPlot2.jpg", sep="/"), width=800, height=800)
	densityPlot(betas, sampGroups = pdata[,group])
	dev.off()

	jpeg(paste(params$out, group, "densityBeanPlot2.jpg", sep="/"), width=800, height=800)
	if(nrow(betas)>200){ #sample function need at least 200 records.
	  densityBeanPlot(betas, sampGroups = pdata[,group])
	}
	dev.off()

	jpeg(paste(params$out, group, "mdsPlot2.jpg", sep="/"), width=800, height=800)
	if (nrow(pdata) < 200 ){
		mdsPlot(betas,numPositions=1000,sampGroups=pdata[,group],
					legendPos = "bottomleft",sampNames=samples)
	}else{
		mdsPlot(betas,numPositions=1000,sampGroups=pdata[,group])
	}
	dev.off()
}
nbprobes2=nrow(betas)
```

```{r PCA, include=FALSE}
#10- PCA
pca<-suppressPackageStartupMessages( makepca( betas, pdata, params$out, colnames(pdata), nPC=10 ) )
pvalue<-pca$pvalue
qvalue<-pca$qvalue
jpeg(paste0(params$out, "/pca_contributions_0001.jpg"))
plot(pca$contrib)
dev.off()
```

```{r deltabetas, include=FALSE}
#11- DeltaBetas
deltab<-""
deltab<-getDeltaBetas(betas,pdata[,groups[1]])
```

```{r violinplot, eval = params$violin, include=FALSE}
#12-violin plot
violin_plot(pdata=pdata, betas=betas, group=groups[1], samples=colnames(samples), platform=platform, path=path, out=params$out, genome=params$genome, regions=regions)
```

```{r mval, include=FALSE}
#13- mvalues
mval=beta2m(betas)
mval[!is.finite(mval)]<-min(mval[is.finite(mval)])
# Remove a probe when sum of betas is 0.
iszero<-which(rowSums(mval) == 0 )
if(length(iszero) > 0){
  mval<-mval[-which(rowSums(mval) == 0 ),]
}
```

```{r save, include=FALSE}
#14- Save and Create report
write.table(pdata, file=paste0(params$out, "/pdata.txt"), row.names=F, sep="\t")
write.table(betas, file=paste0(params$out, "/betas.txt"), row.names=T, sep="\t")
write.table(deltab, file=paste0(params$out, "/deltabetas.txt"), row.names=T, sep="\t")
write.table(pvalue, file=paste0(params$out, "/pvalue_0001.txt"), row.names=T, sep="\t")
write.table(qvalue, file=paste0(params$out, "/qvalue_0001.txt"), row.names=T, sep="\t")
  
save(betas, pdata, samples, groups, platform, genome, regions, mval, file=paste0(params$out, "/meth.rdata") )
```

<!-- --------------------------------Report Section-------------------------------------------- -->

# pdata

[ Sample Sheet ](`r params$out`/pdata.txt)

```{r, echo=FALSE, results ='asis'}
pdata<-fread(paste0(params$out,"/pdata.txt"))
kable(pdata)

```

# betas

[ Betas Normalized ](`r params$out`/betas.txt)

```{r, echo=FALSE, results ='asis', warning=FALSE}
betas<-fread(paste0(params$out,"/betas.txt"),nrows=100)
kable(betas)

```

# delta betas

[ Delta Betas ](`r params$out`/deltabetas.txt)

```{r, echo=FALSE, results ='asis', warning=FALSE}
deltabetas<-fread(paste0(params$out,"/deltabetas.txt"),nrows=100)
kable(deltabetas)

```

# Groups

## Groups {.tabset .tabset-fade .tabset-pills}

```{r, echo=FALSE, results='asis'}

  
	for (group in groups) {
	  
	  cat("### ", group, "\n\n")
	  
	  if (file.exists(paste0(params$out, "/",group, "/densityPlot2.jpg"))){
	   cat("[ ![](", params$out, "/", group, "/densityPlot2.jpg) ](", params$out, "/", group, "/densityPlot2.jpg) \n", sep = "")
	  }
	  
	  if (file.exists(paste0(params$out, "/",group, "/densityBeanPlot2.jpg"))){
	   cat("[ ![](", params$out, "/",group, "/densityBeanPlot2.jpg) ](", params$out, "/", group, "/densityBeanPlot2.jpg) \n", sep = "")
	  }
	  
	  if (file.exists(paste0(params$out, "/",group, "/mdsPlot2.jpg"))){
	   cat("[ ![](", params$out, "/",group, "/mdsPlot2.jpg) ](", params$out, "/", group, "/mdsPlot2.jpg) \n", sep = "")
	  }
	  
	  cat('\n\n')
	  
	}
	
	
```

# PCA 

## 1 {.tabset .tabset-fade .tabset-pills}

### Contributions

[ ![](`r params$out`/pca_contributions_0001.jpg) ](`r params$out`/pca_contributions_0001.jpg)

### [ pvalues ](`r params$out`/pvalue_0001.txt)

```{r, echo=FALSE, results='asis'}
    pvalue<-fread(paste0(params$out,"/pvalue_0001.txt"), header=F)
    sig_pvalue_bold <- formatter("span", style = x ~ style("background-color" = ifelse(x <= 1e-5, "pink", ifelse(x <= 0.05, "palegoldenrod", "transparent"))))
    formattable(pvalue, list(area(col = names(pvalue)[-1]) ~ sig_pvalue_bold ))
    
```

### [ qvalues ](`r params$out`/qvalue_0001.txt)

```{r, echo=FALSE, results='asis'}
    qvalue<-fread(paste0(params$out,"/qvalue_0001.txt"), header=F)
    sig_qvalue_bold <- formatter("span", style = x ~ style("background-color" = ifelse(x <= 1e-5, "pink", ifelse(x <= 0.05, "palegoldenrod", "transparent"))))
    formattable(qvalue, list(area(col = names(qvalue)[-1]) ~ sig_qvalue_bold ))
    
```


