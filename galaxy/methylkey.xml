<?xml version="1.0"?>
<tool id="methylkey" name="Load Data" version="0.2.2">
<description>into methylkey pipeline</description> 

<requirements>
    <requirement type="package" version="2.0" >r-methylkey</requirement>
</requirements>

<command><![CDATA[ 

	#if $data.platform == "rnbeads":
		cp $__tool_directory__/../bin/methylkey_${data.platform}.Rmd index.Rmd;
	#else
                mkdir idat_rep;
                #for $f in $data.idat_collection
        	        ln -s $f idat_rep/${f.name};
                #end for
		cp $__tool_directory__/../bin/methylkey_${data.pipeline.name}.Rmd index.Rmd;
	#end if
	
	mkdir $html.files_path;

	Rscript -e "rmarkdown::render('index.Rmd', params=list( 
	path='$__tool_directory__/../bin' ,
	pdata='$pdata' ,

	#if $data.platform == "rnbeads":
		idat='$data.idat' ,
		genome='$data.genome' ,
	#else
		idat='idat_rep' ,
		barcode='$data.barcode' ,
		pipeline='$data.pipeline.name' ,
		normalize='$data.pipeline.normalize' ,
		filters='$data.filters' ,
		filters='$data.custom' ,
		pval='$data.pval' ,
		#if $data.pipeline.name == "minfi"
			#if $data.pipeline.estimate.cell == "houseman"
				cell='$data.pipeline.estimate.cell' ,
				nbc='$data.pipeline.estimate.nbc' ,
			#end if
		#end if
	#end if

	samples='$sample' ,
	groups='$groups' ,
	nalimit=$nalimit ,
	missing='$missing' ,
	out='report' ,
	violin=$violin ,
	badsamples='$badsamples'
	))";

	mv report $html.files_path/.;

]]></command>

<macros>

<xml name="illumina" token_plt="plt">

	<param name="idat_collection" type="data_collection" format="idat" collection_type="list"/>
	<param name="barcode" type="data_column" data_ref="pdata" label="Barcode" use_header_names="true" force_select="true" value="3"/>
			
	<param name="filters" type="select" label="Remove @PLT@ probes" optional="true" multiple="true" help="Remove probes from list">
		<options from_data_table="illuminaProbes_index" >
			<column name="value" index="3" />
      			<column name="name" index="1" />
			<filter type="static_value" value="@PLT@" column="2"/>
			<validator type="no_options" message="No probes list available for this platform"/>
		</options>
	</param>

	<param name="custom" optional="true" type="data" format="txt" label="Custom list"
    		help="Select text file with probes id to remove (one by line)."/>

	<conditional name="pipeline">
		<param name="name" type="select" display="radio" label="Package" >
			<option value="minfi">minfi</option>
			<option value="methylumi">methylumi</option>
		</param>
				
		<when value="minfi">
		    	<param name="normalize" type="select" display="radio" label="Normalisation" >
		    		<option value="Funnorm">FunNorm</option>
				<option value="Illumina">Illumina</option>
				<option value="Noob">Noob</option>
				<option value="Quantile">Quantile</option>
				<option value="SWAN">SWAN</option>
		    		<option value="Raw">Raw</option>
		    	</param>
		    
			<conditional name="estimate">
				<param name="cell" type="select"  display="radio" label="Etimate cell mixture composition">
					<option value="no">Don't do that</option>
				    	<option value="Houseman">Houseman (blood only)</option>
				</param>
				<when value="no"/>
				<when value="houseman">
					<param name="nbc" type="text" value="?" label="nbc" />
				</when>
			</conditional>
		</when>

		<when value="methylumi">
		    	<param name="normalize" type="select" display="radio" label="Normalisation" >
		    		<option value="bmiq">Bmiq</option>
		    		<option value="none">Don't do that</option>
		    	</param>
		</when>
	</conditional>

	<param name="pval" type="text" value="0.02" label="Filter failed probes using a pvalue threshold" />

</xml>

</macros>


<inputs>
	<param name="pdata" type="data" format="tabular" label="Sample Sheet (phenotypic data)"/>
	
	<param name="sample" type="data_column" data_ref="pdata" label="Sample Names" use_header_names="true" force_select="true" numerical="false"
		help="Warning: if you have space in the name of your column replace it by a dot or an underscore" value="1"/>

	<param name="groups" type="data_column" data_ref="pdata" label="Sample Groups" use_header_names="true" force_select="true" multiple="true" numerical="false"
		help="Warning: if you have space in the name of your column replace it by a dot or an underscore" value="2"/>

	<param name="nalimit" type="text" value="0.05" label="Maximum NA fraction for a probe" 
		help="Remove a probe if its beta value is NA for more than xx% of sample (0.05 = 5%)" />

	<param name="missing" type="select" label="How to deal with missing values">
		<option value="mean">Replace by mean of betas</option>
		<option value="impute">Impute values with pamr</option>
		<option value="keep">Keep it</option>
	</param>
	
	<param name="badsamples" optional="true" type="data" format="txt" label="Samples to remove" help="text file with one sample name by line" />

	<conditional name="data">
		<param name="platform" type="select" label="Platform" >
			<option value="IlluminaHumanMethylationEPIC">Illummina 850K (EPIC)</option>
		    	<option value="IlluminaHumanMethylation450k">Illumina 450k </option>
			<option value="rnbeads">Beta file from RNBeads (with coordinate values)</option>		    
		</param>
		<when value="IlluminaHumanMethylationEPIC">
			<expand macro="illumina" plt="IlluminaHumanMethylationEPIC"/>
		</when>
		<when value="IlluminaHumanMethylation450k">
			<expand macro="illumina" plt="IlluminaHumanMethylation450k"/>
		</when>
		<when value="rnbeads">
			<param name="idat" type="data" format="txt" label="betas file from rnbeads (with coordinate)"/>
			<param name="genome" type="select" label="Genome" >
				<option value="hg19">GRCH38/HG38</option>
			    	<option value="hg38">GRCH37/HG19</option>
			</param>
		</when>	
	</conditional>

	<param name="violin" type="boolean" label="Draw violin plot with betas values" truevalue="TRUE" falsevalue="FALSE" checked="true" />
	
</inputs>

<outputs>
	<data name="html" format="html" label="${pdata.name} QC" from_work_dir="index.html"/>
</outputs>





<stdio>
<regex match="Warning message:"
           source="both"
           level="warning"
           description="Warning message:" />
<regex match="PreprocessNoob:"
           source="both"
           level="warning"
           description="Warning message:" />
<regex match="error"
           source="both"
           level="fatal"
           description="error encountered" />
</stdio>


<help>

**What it does**

Read idat file and get normalized betas values.
You can also estimate cell mixture composition with Houseman for blood sample or RefFreeEwasher.

You can choose between minfi or methylumi package.

**Inputs**
	
Phenotypic data file in tabular format (pdata).
	
Collection of idat files from a 450k or Epic analysis.

**Example of pdata file**

+---------------------+--------------+------------------+-----------+------------+--------+--------+
|       barcode	      |  sentrix_id  | sentrix_position	| sample_id | Patient_id | group  | Gender |
+=====================+==============+==================+===========+============+========+========+
| 200882160087_R06C01 |	200882160087 | R06C01           | FS01      | P01   	 | Normal | M      |
+---------------------+--------------+------------------+-----------+------------+--------+--------+
| 200882160087_R03C01 |	200882160087 | R03C01	        | FS02	    | P01        | Tumor  | M      |
+---------------------+--------------+------------------+-----------+------------+--------+--------+
| 200882160117_R01C01 |	200882160117 | R01C01	        | FS03	    | P02        | Normal | F      |
+---------------------+--------------+------------------+-----------+------------+--------+--------+
|200882160087_R05C01  | 200882160087 | R05C01	        | FS04      | P02        | Tumor  | F      |
+---------------------+--------------+------------------+-----------+------------+--------+--------+


**code**

minfi : http://git.iarc.lan/EGE/methylkey/blob/master/minfi.r
methylumi : http://git.iarc.lan/EGE/methylkey/blob/master/methylumi.r


**Cross reactive probes**

***450k***

Chen YA, Lemire M, Choufani S, Butcher DT, Grafodatskaya D, Zanke BW, Gallinger S, Hudson TJ, Weksberg R. Discovery of cross-reactive probes and polymorphic CpGs in the Illumina Infinium HumanMethylation450 microarray. Epigenetics. 2013 Jan 11;8(2) : https://www.ncbi.nlm.nih.gov/pmc/articles/PMC3592906/

***EPIC***

Pidsley R., et al., Critical evaluation of the Illumina MethylationEPIC BeadChip microarray for whole-genome DNA methylation profiling. Genome Biol, 2016. 17(1): p. 208 10.1186/s13059-016-1066-1 : https://www.ncbi.nlm.nih.gov/pmc/articles/PMC5055731/

**The methylkey pipeline**

.. image:: methylkey.png
	:height: 412
	:width: 562


</help>

</tool>
