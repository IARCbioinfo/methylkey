<?xml version="1.0"?>
<tool id="dmrs" name="DMRs" version="0.1.2">
<description>Meth analysis by region</description>

<requirements>
    <requirement type="package" version="2.0" >r-methylkey</requirement>
</requirements>

<command>
	#import re
	#set inputDir=$re.sub("\.dat","_files",str($input))
	#set outputDir=$re.sub("\.dat","_files/",str($html))

	cp $__tool_directory__/../bin/methylkey_dmrcate.Rmd index.Rmd;

	mkdir $html.files_path;

	Rscript -e "rmarkdown::render('index.Rmd', params=list( 

	meth='$inputDir/report/meth.rdata' ,

	#if $dmr.package=="dmrcate"
		type='$dmr.analysis_type' ,
                fdr=$dmr.fdr ,
	        pval=$dmr.pcutoff ,
	#elif $dmr.package=="bumphunter"
		cpu=$dmr.nbcor ,
	        test=$dmr.method ,
                mval=$dmr.mval ,
                minNumOfCpgs=$dmr.minNumOfCpgs ,
	#else
	        min=$dmr.minProbeNum ,
                pval=$dmr.pValueTh ,
                window=$dmr.winsize ,
                fdr=$dmr.fdr ,
	#end if
	out='report'))";

	mv report $html.files_path/.;
</command>

<inputs>

	<param name="input" type="data" format="html" label="report"/>
	
	<conditional name="dmr">
		<param name="package" type="select" label="Method">
			<option value="dmrcate">DMRcate</option>
			<option value="bumphunter">Bumphunter</option>
		</param>
		<when value="dmrcate">
			<param name="analysis_type" type="select" label="Type of Analysis">
				<option value="differential">differential (DMRs)</option>
				<option value="variability">variability (VMRs)</option>
			</param>
			<param name="fdr" type="text" value="0.05" label="FDR cutoff" help="FDR cutoff (Benjamini-Hochberg) for which CpG sites are individually called as  significant.   Used  only  to  determine  effect  size,  and  not  for  downstream thresholding."/>
			<param name="pcutoff" type="text" value="0.2" label="pcutoff" help="p-value cutoff to determine DMRs."/>
		</when>
		<when value="bumphunter">
			<param name="method" type="select" label="Test" help="The use of the permutation test is not recommended with multiple covariates, (ncol(design)>2).">
				<option value="permutation">permutation</option>
				<option value="bootstrap">bootstrap</option>
			</param>
			<param name="mval" type="boolean" checked="false" truevalue="-mval" falsevalue="" label="use mvalues" help="convert betas to mvalues, recommended for small datasets" />
			<param name="minNumOfCpgs" type="text" value="2" label="Minimum number of CpG for a DMRs" />
			<param name="nbcor" type="text" value="4" label="number of process" />	
		</when>
	</conditional>
	
	<param name="max" type="text" value="10" label="Max dmrs to plot" />

</inputs>

<outputs>
    <data name="html" format="html" label="${dmr.package} on ${on_string}" from_work_dir="index.html"/>
</outputs>

<stdio>
    <regex match="Warning message:"
           source="both"
           level="warning"
           description="Warning message:" />
</stdio>

<help>


</help>

</tool>
